"use strict";angular.module("financiamientoClimaticoApp",["ngResource","ngRoute","ngSanitize","bootstrapComponents"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]),angular.module("financiamientoClimaticoApp").controller("MainCtrl",["$scope","Api","Utilities","Settings",function(a,b,c,d){var e=this;this.options=b.data.options,this.data=b.data,this.states=b.data.states,this.defaultColor=d.defaultColor(),this.filters={year:null,state:null,financing:null,focus:null,status:null,project:null},this.investmentColors=d.rangeColors(),this.kpis={investment:0},this.filtersAvailable=function(){return this.filters.year||this.filters.state||this.filters.financing||this.filters.focus||this.filters.status},this.addInvestment=function(a){this.kpis.investment+=a},this.resetInvestment=function(){this.kpis.investment=0},e.filterRecords=function(a){return c.applyFilterToRecord(e.filters.year,a.ano_aprobacion)&&c.applyFilterToRecord(e.filters.state,a.region)&&c.applyFilterToRecord(e.filters.financing,a.financiamiento)&&c.applyFilterToRecord(e.filters.focus,a.area_proyecto)&&c.applyFilterToRecord(e.filters.status,a.status)},e.investmentByState=function(){b.investmentByStateForProjects(this.main.results)},b.fetchDataset()}]),angular.module("financiamientoClimaticoApp").controller("MexicoCtrl",["$scope","Api","Settings",function(a,b,c){this.getInvestmentStateColor=function(d){if(angular.isUndefined(a.main.results))return c.defaultColor();{var e=b.investmentByStateForProjects(a.main.results,d);c.getColorFromInvestment(e)}return a.main.addInvestment(e),c.getColorFromInvestment(e)}}]).directive("mexicoMap",function(){return{replace:!0,template:'<div id="mexicoMapSvg"></div>',restrict:"E",controller:"MexicoCtrl",controllerAs:"map",link:function(a,b){var c=void 0,d=960,e=420,f=(d3.scale.linear().domain([0,d]).range([0,d]),d3.scale.linear().domain([0,e]).range([e,0]),d3.geo.mercator().scale(1200).center([-95.34034978813841,22.012062015793])),g=d3.select(b[0]).append("svg").attr("width",d).attr("height",e),h=d3.select("body").append("div").attr("id","tooltip"),i=g.append("g"),j=function(a){return"<span>"+a+"</span>"},k=function(b){a.main.resetInvestment(),angular.isUndefined(b)||i.selectAll("path").data(topojson.object(b,b.objects.states).geometries).enter().append("path").attr("d",d3.geo.path().projection(f)).attr("class","default").attr("state",function(a,c){return b.objects.states.geometries[c].properties.state_name}).attr("fill",function(b){var c=b.properties.state_name,d=a.map.getInvestmentStateColor(c);return d}).on("mouseover",function(a){h.transition().duration(200).style("opacity",.9),h.html(j(a.properties.state_name)).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-75+"px")}).on("mouseout",function(){h.transition().duration(500).style("opacity",0)}).on("click",function(b){d3.event.stopPropagation(),a.main.filters.state=b.properties.state_name,a.$apply()})};d3.json("mx_tj.json",function(b,d){c=d,k(c),a.$apply()}),a.$watch("main.results",function(a,b){angular.equals(a,b)||(i.selectAll("path").remove(),k(c))},!0)}}}),angular.module("financiamientoClimaticoApp").factory("Api",["$http",function(a){var b=function(a,b){return _.uniq(_.pluck(a,b))};return{data:{records:void 0,options:{years:void 0,financing:void 0,focus:void 0,status:void 0},states:["Distrito Federal","Guerrero","México","Morelos","Sinaloa","Baja California","Sonora","Baja California Sur","Zacatecas","Durango","Chihuahua","Colima","Nayarit","Michoacán","Jalisco","Chiapas","Tabasco","Oaxaca","Guanajuato","Aguascalientes","Querétaro","San Luis Potosí","Tlaxcala","Puebla","Hidalgo","Veracruz","Nuevo León","Coahuila","Tamaulipas","Yucatán","Campeche","Quintana Roo"]},investmentByStateForProjects:function(a,b){var c=_.where(a,{region:b}),d=_.pluck(c,"cantidad"),e=_.reduce(d,function(a,b){return a+parseInt(b)},0);return e},fetchDataset:function(){var c=this;angular.isUndefined(c.data.records)&&a.get(this.url()).success(function(a){c.data.records=a.result.records,c.data.options.years=b(c.data.records,"ano_aprobacion"),c.data.options.financing=b(c.data.records,"financiamiento"),c.data.options.focus=b(c.data.records,"area_proyecto"),c.data.options.status=b(c.data.records,"status")})},url:function(){return"datastore_search.json"}}}]),angular.module("financiamientoClimaticoApp").factory("Settings",function(){var a=Math.pow(2,53),b="white",c="#2196F3",d="#FFEB3B",e="#FF9800",f="#F44336",g=Math.pow(10,5),h=Math.pow(10,6),i=Math.pow(10,7),j=a,k=[{initial:1,limit:g,color:c},{initial:g,limit:h,color:d},{initial:h,limit:i,color:e},{initial:i,limit:j,color:f}];return{defaultColor:function(){return b},rangeColors:function(){return[c,d,e,f]},getColorFromInvestment:function(a){for(var b=0;b<k.length;b++){if(0===a)return this.defaultColor();if(a>=k[b].initial&&a<k[b].limit)return k[b].color}}}}),angular.module("financiamientoClimaticoApp").factory("Utilities",function(){return{applyFilterToRecord:function(a,b){return null===a||angular.equals(b,a)},applyStateFilter:function(a,b){var b=b.toLowerCase();return null===a||-1!==a.toLowerCase().indexOf(b)}}}),angular.module("financiamientoClimaticoApp").filter("humanizeInt",function(){return function(a){return Humanize.formatNumber(a)}}),angular.module("bootstrapComponents",[]).directive("closableTag",function(){return{template:'<span ng-show="value" class="tag label label-info"><span>{{ value }}</span>&nbsp;<span class="close-tag" ng-click="remove(value)">&#x2716;</span></span>',restrict:"E",scope:{value:"="},controller:["$scope",function(a){a.remove=function(){this.value=null}}],link:function(){}}});