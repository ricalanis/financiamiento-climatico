"use strict";angular.module("financiamientoClimaticoApp",["ngResource","ngRoute","ngSanitize","mm.foundation","angularUtils.directives.dirPagination","bootstrapComponents"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]),angular.module("financiamientoClimaticoApp").controller("MainCtrl",["$scope","Api","Utilities","Settings",function(a,b,c,d){var e=this;this.options=b.data.options,this.data=b.data,this.states=b.data.states,this.defaultColor=d.defaultColor(),this.isOpen=[],this.filters={year:void 0,state:void 0,financing:void 0,focus:void 0,status:void 0,project:void 0},this.investmentColors=d.rangeColors(),this.kpis={investment:0},this.filtersAvailable=function(){return this.filters.year||this.filters.state||this.filters.financing||this.filters.focus||this.filters.status},this.addInvestment=function(a){this.kpis.investment+=a},this.resetInvestment=function(){this.kpis.investment=0},e.investmentByState=function(){b.investmentByStateForProjects(this.main.results)},b.fetchDataset()}]),angular.module("financiamientoClimaticoApp").controller("MexicoCtrl",["$scope","Api","Settings",function(a,b,c){this.totalInvestmentInState=function(c){return angular.isUndefined(a.main.results)?0:b.investmentByStateForProjects(a.main.results,c)},this.getInvestmentStateColor=function(d){if(angular.isUndefined(a.main.results))return c.defaultColor();{var e=b.investmentByStateForProjects(a.main.results,d);c.getColorFromInvestment(e)}return a.main.addInvestment(e),c.getColorFromInvestment(e)}}]).directive("mexicoMap",["$filter",function(a){return{replace:!0,template:'<div id="mexicoMapSvg"></div>',restrict:"E",controller:"MexicoCtrl",controllerAs:"map",link:function(b,c){var d=void 0,e=960,f=420,g=(d3.scale.linear().domain([0,e]).range([0,e]),d3.scale.linear().domain([0,f]).range([f,0]),d3.geo.mercator().scale(1200).center([-95.34034978813841,22.012062015793])),h=d3.select(c[0]).append("svg").attr("width",e).attr("height",f),i=d3.select("body").append("div").attr("id","tooltip"),j=h.append("g"),k=function(a){return"<span>"+a+"</span>"},l=function(c){b.main.resetInvestment(),angular.isUndefined(c)||j.selectAll("path").data(topojson.object(c,c.objects.states).geometries).enter().append("path").attr("d",d3.geo.path().projection(g)).attr("class","default").attr("state",function(a,b){return c.objects.states.geometries[b].properties.state_name}).attr("fill",function(a){var c=a.properties.state_name,d=b.map.getInvestmentStateColor(c);return d}).on("mouseover",function(c){var d=c.properties.state_name,e=b.map.totalInvestmentInState(d);i.transition().duration(200).style("opacity",.9),i.html(k(d+": $"+a("humanizeInt")(e)+" USD")).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-75+"px")}).on("mouseout",function(){i.transition().duration(500).style("opacity",0)}).on("click",function(a){d3.event.stopPropagation(),b.main.filters.state=a.properties.state_name,b.$apply()})};d3.json("mx_tj.json",function(a,c){d=c,l(d),b.$apply()}),b.$watch("main.results",function(a,b){angular.equals(a,b)||(j.selectAll("path").remove(),l(d))},!0)}}}]),angular.module("financiamientoClimaticoApp").factory("Api",["$http","$filter",function(a,b){var c=function(a,b){return _.uniq(_.pluck(a,b))};return{data:{records:void 0,options:{years:void 0,financing:void 0,focus:void 0,status:void 0},states:["Distrito Federal","Guerrero","México","Morelos","Sinaloa","Baja California","Sonora","Baja California Sur","Zacatecas","Durango","Chihuahua","Colima","Nayarit","Michoacán","Jalisco","Chiapas","Tabasco","Oaxaca","Guanajuato","Aguascalientes","Querétaro","San Luis Potosí","Tlaxcala","Puebla","Hidalgo","Veracruz","Nuevo León","Coahuila","Tamaulipas","Yucatán","Campeche","Quintana Roo"]},investmentByStateForProjects:function(a,c){for(var d=b("filter")(a,{region:c}),e=d.length,f=0,g=0;e>g;g++){var h=d[g].region.split(","),i=h.length,j=parseInt(d[g].cantidad);f+=i>1?j/i:j}return f},fetchDataset:function(){var b=this;angular.isUndefined(b.data.records)&&a.get(this.url()).success(function(a){b.data.records=a.result.records,b.data.options.years=c(b.data.records,"ano_aprobacion"),b.data.options.financing=c(b.data.records,"financiamiento"),b.data.options.focus=c(b.data.records,"area_proyecto"),b.data.options.status=c(b.data.records,"status")})},url:function(){return"//datamx.io/api/action/datastore_search_sql?sql=SELECT%20*%20from%20%2239774bca-713e-46c5-bbbb-dfda9cc94be3%22"}}}]),angular.module("financiamientoClimaticoApp").factory("Settings",function(){var a=Math.pow(2,53),b="white",c="#2196F3",d="#FFEB3B",e="#FF9800",f="#F44336",g=Math.pow(10,5),h=Math.pow(10,6),i=Math.pow(10,7),j=a,k=[{initial:1,limit:g,color:c},{initial:g,limit:h,color:d},{initial:h,limit:i,color:e},{initial:i,limit:j,color:f}];return{defaultColor:function(){return b},rangeColors:function(){return[c,d,e,f]},getColorFromInvestment:function(a){for(var b=0;b<k.length;b++){if(0===a)return this.defaultColor();if(a>=k[b].initial&&a<k[b].limit)return k[b].color}}}}),angular.module("financiamientoClimaticoApp").factory("Utilities",function(){return{applyFilterToRecord:function(a,b){return null===a||angular.equals(b,a)},applyStateFilter:function(a,b){var b=b.toLowerCase();return null===a||-1!==a.toLowerCase().indexOf(b)}}}),angular.module("financiamientoClimaticoApp").filter("humanizeInt",function(){return function(a){return Humanize.formatNumber(a,2)}}),angular.module("bootstrapComponents",[]).directive("closableTag",function(){return{template:'<span ng-show="value" class="tag label label-info"><span>{{ value }}</span>&nbsp;<span class="close-tag" ng-click="remove(value)">&#x2716;</span></span>',restrict:"E",scope:{value:"="},controller:["$scope",function(a){a.remove=function(){this.value=void 0}}],link:function(){}}});