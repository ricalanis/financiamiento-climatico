"use strict";angular.module("financiamientoClimaticoApp",["ngResource","ngRoute","ngSanitize"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]),topojson=function(){function a(a,b){function c(b){var c=a.arcs[b],d=c[0],e=[0,0];return c.forEach(function(a){e[0]+=a[0],e[1]+=a[1]}),[d,e]}var d={},e={},f={};b.forEach(function(a){var b=c(a);(d[b[0]]||(d[b[0]]=[])).push(a),(d[b[1]]||(d[b[1]]=[])).push(~a)}),b.forEach(function(a){var b,d,g=c(a),h=g[0],i=g[1];if(b=f[h])if(delete f[b.end],b.push(a),b.end=i,d=e[i]){delete e[d.start];var j=d===b?b:b.concat(d);e[j.start=b.start]=f[j.end=d.end]=j}else if(d=f[i]){delete e[d.start],delete f[d.end];var j=b.concat(d.map(function(a){return~a}).reverse());e[j.start=b.start]=f[j.end=d.start]=j}else e[b.start]=f[b.end]=b;else if(b=e[i])if(delete e[b.start],b.unshift(a),b.start=h,d=f[h]){delete f[d.end];var k=d===b?b:d.concat(b);e[k.start=d.start]=f[k.end=b.end]=k}else if(d=e[h]){delete e[d.start],delete f[d.end];var k=d.map(function(a){return~a}).reverse().concat(b);e[k.start=d.end]=f[k.end=b.end]=k}else e[b.start]=f[b.end]=b;else if(b=e[h])if(delete e[b.start],b.unshift(~a),b.start=i,d=f[i]){delete f[d.end];var k=d===b?b:d.concat(b);e[k.start=d.start]=f[k.end=b.end]=k}else if(d=e[i]){delete e[d.start],delete f[d.end];var k=d.map(function(a){return~a}).reverse().concat(b);e[k.start=d.end]=f[k.end=b.end]=k}else e[b.start]=f[b.end]=b;else if(b=f[i])if(delete f[b.end],b.push(~a),b.end=h,d=f[h]){delete e[d.start];var j=d===b?b:b.concat(d);e[j.start=b.start]=f[j.end=d.end]=j}else if(d=e[h]){delete e[d.start],delete f[d.end];var j=b.concat(d.map(function(a){return~a}).reverse());e[j.start=b.start]=f[j.end=d.start]=j}else e[b.start]=f[b.end]=b;else b=[a],e[b.start=h]=f[b.end=i]=b});var g=[];for(var h in f)g.push(f[h]);return g}function b(b,d,e){function f(a){0>a&&(a=~a),(l[a]||(l[a]=[])).push(k)}function g(a){a.forEach(f)}function h(a){a.forEach(g)}function i(a){"GeometryCollection"===a.type?a.geometries.forEach(i):a.type in m&&(k=a,m[a.type](a.arcs))}var j=[];if(arguments.length>1){var k,l=[],m={LineString:g,MultiLineString:h,Polygon:h,MultiPolygon:function(a){a.forEach(h)}};i(d),l.forEach(3>arguments.length?function(a,b){j.push([b])}:function(a,b){e(a[0],a[a.length-1])&&j.push([b])})}else for(var n=0,o=b.arcs.length;o>n;++n)j.push([n]);return c(b,{type:"MultiLineString",arcs:a(b,j)})}function c(a,b){function c(a,b){b.length&&b.pop();for(var c,e=o[0>a?~a:a],f=0,g=e.length,h=0,i=0;g>f;++f)b.push([(h+=(c=e[f])[0])*k+m,(i+=c[1])*l+n]);0>a&&d(b,g)}function e(a){return[a[0]*k+m,a[1]*l+n]}function f(a){for(var b=[],d=0,e=a.length;e>d;++d)c(a[d],b);return 2>b.length&&b.push(b[0]),b}function g(a){for(var b=f(a);4>b.length;)b.push(b[0]);return b}function h(a){return a.map(g)}function i(a){var b=a.type,c="GeometryCollection"===b?{type:b,geometries:a.geometries.map(i)}:b in p?{type:b,coordinates:p[b](a)}:{type:null};return"id"in a&&(c.id=a.id),"properties"in a&&(c.properties=a.properties),c}var j=a.transform,k=j.scale[0],l=j.scale[1],m=j.translate[0],n=j.translate[1],o=a.arcs,p={Point:function(a){return e(a.coordinates)},MultiPoint:function(a){return a.coordinates.map(e)},LineString:function(a){return f(a.arcs)},MultiLineString:function(a){return a.arcs.map(f)},Polygon:function(a){return h(a.arcs)},MultiPolygon:function(a){return a.arcs.map(h)}};return i(b)}function d(a,b){for(var c,d=a.length,e=d-b;--d>e;)c=a[e],a[e++]=a[d],a[d]=c}function e(a,b){for(var c=0,d=a.length;d>c;){var e=c+d>>>1;b>a[e]?c=e+1:d=e}return c}function f(a){function b(a,b){a.forEach(function(a){0>a&&(a=~a);var c=f[a]||(f[a]=[]);c[b]||(c.forEach(function(a){var c,d;d=e(c=g[b],a),c[d]!==a&&c.splice(d,0,a),d=e(c=g[a],b),c[d]!==b&&c.splice(d,0,b)}),c[b]=b)})}function c(a,c){a.forEach(function(a){b(a,c)})}function d(a,b){"GeometryCollection"===a.type?a.geometries.forEach(function(a){d(a,b)}):a.type in h&&h[a.type](a.arcs,b)}var f=[],g=a.map(function(){return[]}),h={LineString:b,MultiLineString:c,Polygon:c,MultiPolygon:function(a,b){a.forEach(function(a){c(a,b)})}};return a.forEach(d),g}return{version:"0.0.32",mesh:b,object:c,neighbors:f}}(),angular.module("financiamientoClimaticoApp").controller("MainCtrl",["$scope","Api",function(a,b){var c=this;this.options=b.data.options,this.data=b.data,this.filters={year:null,financing:null,focus:null,project:null};var d=function(a,b){return null===a||angular.equals(b,a)};c.filterRecords=function(a){return d(c.filters.year,a.ano_aprobacion)&&d(c.filters.financing,a.financiamiento)&&d(c.filters.focus,a.area_proyecto)},c.investmentByState=function(){b.investmentByStateForProjects(this.main.results)},b.fetchDataset()}]),angular.module("financiamientoClimaticoApp").controller("MexicoCtrl",["$scope","Api","Settings",function(a,b,c){this.getInvestmentStateColor=function(d){if(angular.isUndefined(a.main.results))return c.defaultColor();var e=b.investmentByStateForProjects(a.main.results,d),f=c.getColorFromInvestment(e);return console.log(d+" "+e+" "+f),c.getColorFromInvestment(e)}}]).directive("mexicoMap",function(){return{replace:!0,template:'<div id="mexicoMapSvg"># de proyectos: {{ main.results.length }}</div>',restrict:"E",controller:"MexicoCtrl",controllerAs:"map",link:function(a,b){var c=void 0,d=960,e=500,f=(d3.scale.linear().domain([0,d]).range([0,d]),d3.scale.linear().domain([0,e]).range([e,0]),d3.geo.mercator().scale(1200).center([-102.34034978813841,24.012062015793])),g=d3.select(b[0]).append("svg").attr("width",d).attr("height",e),h=g.append("g"),i=function(b){angular.isUndefined(b)||h.selectAll("path").data(topojson.object(b,b.objects.states).geometries).enter().append("path").attr("d",d3.geo.path().projection(f)).style("stroke","#a9a9a9").attr("class","default").attr("state",function(a,c){return b.objects.states.geometries[c].properties.state_name}).attr("fill",function(b){var c=b.properties.state_name,d=a.map.getInvestmentStateColor(c);return d})};d3.json("mx_tj.json",function(a,b){c=b,i(c)}),a.$watch("main.results",function(a,b){angular.equals(a,b)||(console.log("calling draw map"),h.selectAll("path").remove(),i(c),console.log("finish drawing map"))},!0)}}}),angular.module("financiamientoClimaticoApp").factory("Api",["$http",function(a){var b=function(a,b){return _.uniq(_.pluck(a,b))};return{data:{records:void 0,options:{years:void 0,financing:void 0,focus:void 0},states:["Distrito Federal","Guerrero","México","Morelos","Sinaloa","Baja California","Sonora","Baja California Sur","Zacatecas","Durango","Chihuahua","Colima","Nayarit","Michoacán de Ocampo","Jalisco","Chiapas","Tabasco","Oaxaca","Guanajuato","Aguascalientes","Querétaro","San Luis Potosí","Tlaxcala","Puebla","Hidalgo","Veracruz de Ignacio de la Llave","Nuevo León","Coahuila de Zaragoza","Tamaulipas","Yucatán","Campeche","Quintana Roo"]},investmentByStateForProjects:function(a,b){var c=_.where(a,{region:b}),d=_.pluck(c,"cantidad"),e=_.reduce(d,function(a,b){return a+parseInt(b)},0);return e},fetchDataset:function(){var c=this;angular.isUndefined(c.data.records)&&a.get(this.url()).success(function(a){c.data.records=a.result.records,c.data.options.years=b(c.data.records,"ano_aprobacion"),c.data.options.financing=b(c.data.records,"financiamiento"),c.data.options.focus=b(c.data.records,"area_proyecto")})},url:function(){return"datastore_search.json"}}}]),angular.module("financiamientoClimaticoApp").factory("Settings",function(){var a=Math.pow(2,53),b="#DDC",c=b,d="#42A5F5",e="#FFA726",f="#EF5350",g=Math.pow(10,5),h=Math.pow(10,6),i=Math.pow(10,7),j=a,k=[{initial:0,limit:g,color:c},{initial:g,limit:h,color:d},{initial:h,limit:i,color:e},{initial:i,limit:j,color:f}];return{defaultColor:function(){return b},getColorFromInvestment:function(a){for(var b=0;b<k.length;b++){if(0===a)return"#FFFDE7";if(a>=k[b].initial&&a<k[b].limit)return k[b].color}}}});