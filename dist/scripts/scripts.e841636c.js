"use strict";angular.module("financiamientoClimaticoApp",["ngResource","ngRoute","ngSanitize"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]),angular.module("financiamientoClimaticoApp").controller("MainCtrl",["$scope","Api","Utilities",function(a,b,c){var d=this;this.options=b.data.options,this.data=b.data,this.states=b.data.states,this.filters={year:null,state:null,financing:null,focus:null,status:null,project:null},this.kpis={investment:0},this.addInvestment=function(b){this.kpis.investment+=b,a.$apply()},this.resetInvestment=function(){this.kpis.investment=0},d.filterRecords=function(a){return c.applyFilterToRecord(d.filters.year,a.ano_aprobacion)&&c.applyFilterToRecord(d.filters.state,a.region)&&c.applyFilterToRecord(d.filters.financing,a.financiamiento)&&c.applyFilterToRecord(d.filters.focus,a.area_proyecto)&&c.applyFilterToRecord(d.filters.status,a.status)},d.investmentByState=function(){b.investmentByStateForProjects(this.main.results)},b.fetchDataset()}]),angular.module("financiamientoClimaticoApp").controller("MexicoCtrl",["$scope","Api","Settings",function(a,b,c){this.getInvestmentStateColor=function(d){if(angular.isUndefined(a.main.results))return c.defaultColor();{var e=b.investmentByStateForProjects(a.main.results,d);c.getColorFromInvestment(e)}return a.main.addInvestment(e),c.getColorFromInvestment(e)}}]).directive("mexicoMap",function(){return{replace:!0,template:'<div id="mexicoMapSvg"># de proyectos: {{ main.results.length }}</div>',restrict:"E",controller:"MexicoCtrl",controllerAs:"map",link:function(a,b){var c=void 0,d=960,e=500,f=(d3.scale.linear().domain([0,d]).range([0,d]),d3.scale.linear().domain([0,e]).range([e,0]),d3.geo.mercator().scale(1200).center([-102.34034978813841,24.012062015793])),g=d3.select(b[0]).append("svg").attr("width",d).attr("height",e),h=g.append("g"),i=function(b){a.main.resetInvestment(),angular.isUndefined(b)||h.selectAll("path").data(topojson.object(b,b.objects.states).geometries).enter().append("path").attr("d",d3.geo.path().projection(f)).style("stroke","#a9a9a9").attr("class","default").attr("state",function(a,c){return b.objects.states.geometries[c].properties.state_name}).attr("fill",function(b){var c=b.properties.state_name,d=a.map.getInvestmentStateColor(c);return d})};d3.json("mx_tj.json",function(a,b){c=b,i(c)}),a.$watch("main.results",function(a,b){angular.equals(a,b)||(console.log("calling draw map"),h.selectAll("path").remove(),i(c),console.log("finished drawing map"))},!0)}}}),angular.module("financiamientoClimaticoApp").factory("Api",["$http",function(a){var b=function(a,b){return _.uniq(_.pluck(a,b))};return{data:{records:void 0,options:{years:void 0,financing:void 0,focus:void 0,status:void 0},states:["Distrito Federal","Guerrero","México","Morelos","Sinaloa","Baja California","Sonora","Baja California Sur","Zacatecas","Durango","Chihuahua","Colima","Nayarit","Michoacán","Jalisco","Chiapas","Tabasco","Oaxaca","Guanajuato","Aguascalientes","Querétaro","San Luis Potosí","Tlaxcala","Puebla","Hidalgo","Veracruz","Nuevo León","Coahuila","Tamaulipas","Yucatán","Campeche","Quintana Roo"]},investmentByStateForProjects:function(a,b){var c=_.where(a,{region:b}),d=_.pluck(c,"cantidad"),e=_.reduce(d,function(a,b){return a+parseInt(b)},0);return e},fetchDataset:function(){var c=this;angular.isUndefined(c.data.records)&&a.get(this.url()).success(function(a){c.data.records=a.result.records,c.data.options.years=b(c.data.records,"ano_aprobacion"),c.data.options.financing=b(c.data.records,"financiamiento"),c.data.options.focus=b(c.data.records,"area_proyecto"),c.data.options.status=b(c.data.records,"status")})},url:function(){return"datastore_search.json"}}}]),angular.module("financiamientoClimaticoApp").factory("Settings",function(){var a=Math.pow(2,53),b="#DDC",c=b,d="#42A5F5",e="#FFA726",f="#EF5350",g=Math.pow(10,5),h=Math.pow(10,6),i=Math.pow(10,7),j=a,k=[{initial:0,limit:g,color:c},{initial:g,limit:h,color:d},{initial:h,limit:i,color:e},{initial:i,limit:j,color:f}];return{defaultColor:function(){return b},getColorFromInvestment:function(a){for(var b=0;b<k.length;b++){if(0===a)return"white";if(a>=k[b].initial&&a<k[b].limit)return k[b].color}}}}),angular.module("financiamientoClimaticoApp").factory("Utilities",function(){return{applyFilterToRecord:function(a,b){return null===a||angular.equals(b,a)},applyStateFilter:function(a,b){var b=b.toLowerCase();return null===a||-1!==a.toLowerCase().indexOf(b)}}});